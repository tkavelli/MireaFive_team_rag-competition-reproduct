# –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (Hit@5: 36.40%)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–µ.

## üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç

- **Hit@5**: 36.40%
- **–ú–æ–¥–µ–ª—å**: Qwen/Qwen3-Embedding-8B
- **Submission —Ñ–∞–π–ª**: `outputs/submission_qwen3_rrf_v2_stable.csv`
- **–î–∞—Ç–∞**: 2025-11-16

---

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **GPU**: NVIDIA RTX 4090 –∏–ª–∏ –∞–Ω–∞–ª–æ–≥ (‚â•24GB VRAM)
- **RAM**: ‚â•32GB
- **Disk**: ‚â•20GB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ (–º–æ–¥–µ–ª—å ~15GB)
- **OS**: Linux (–ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ Arch Linux)

### –°–æ—Ñ—Ç

- Python 3.10+ (–ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: Python 3.13)
- **CUDA 12.8** –∏–ª–∏ –≤—ã—à–µ (—Å–∏—Å—Ç–µ–º–∞: CUDA 13.0, PyTorch —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω —Å 12.8)
- Git
- PyTorch 2.8.0+cu128 (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ --index-url, —Å–º. –Ω–∏–∂–µ)

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone <repository-url>
cd retrieval-competition
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python -m venv .venv
source .venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PyTorch 2.8.0 —Å CUDA 12.8 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
pip3 install torch==2.8.0 torchvision==0.23.0 --index-url https://download.pytorch.org/whl/cu128

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: GPU –≤–µ—Ä—Å–∏—è FAISS –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
# pip install faiss-gpu==1.12.0
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –µ—Å—Ç—å –¥–≤–∞ —Ñ–∞–π–ª–∞:

- `questions_clean.csv` (~6,977 –≤–æ–ø—Ä–æ—Å–æ–≤)
- `websites.csv` (~1,937 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞
ls -lh questions_clean.csv websites.csv
```

### 4. –ó–∞–ø—É—Å–∫ pipeline

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
bash run_qwen3_rrf_v2_stable.sh
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~15-30 –º–∏–Ω—É—Ç –Ω–∞ RTX 4090

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤

–î–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã:

```
retrieval-competition/
‚îú‚îÄ‚îÄ questions_clean.csv                    # –ò—Å—Ö–æ–¥–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
‚îú‚îÄ‚îÄ websites.csv                           # –ö–æ—Ä–ø—É—Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ requirements.txt                       # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ run_qwen3_rrf_v2_stable.sh            # –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞)
‚îÇ
‚îú‚îÄ‚îÄ pipelines/
‚îÇ   ‚îî‚îÄ‚îÄ retrieve.py                       # –û—Å–Ω–æ–≤–Ω–æ–π retrieval pipeline
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ chunker.py                        # –ß–∞–Ω–∫–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ retriever.py                      # Hybrid retriever (FAISS + BM25)
‚îÇ   ‚îî‚îÄ‚îÄ models/
‚îÇ       ‚îú‚îÄ‚îÄ embedding_models.py           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π
‚îÇ       ‚îî‚îÄ‚îÄ qwen3_embedding_stable.py     # Qwen3 wrapper
‚îÇ
‚îî‚îÄ‚îÄ outputs/
    ‚îî‚îÄ‚îÄ submission_qwen3_rrf_v2_stable.csv  # –†–µ–∑—É–ª—å—Ç–∞—Ç (—Å–æ–∑–¥–∞—Å—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞)
```

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∏–∑ `run_qwen3_rrf_v2_stable.sh`)

```bash
python pipelines/retrieve.py \
  --queries questions_clean.csv \
  --corpus websites.csv \
  --out outputs/submission_qwen3_rrf_v2_stable.csv \
  --model "Qwen/Qwen3-Embedding-8B" \
  --chunk_version ch_v5 \
  --model_name qwen3_8b \
  --chunk_size 2048 \
  --overlap 200 \
  --batch_size 2 \
  --top_k 5 \
  --use_hybrid
```

### –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| `--model` | `Qwen/Qwen3-Embedding-8B` | Embedding –º–æ–¥–µ–ª—å |
| `--chunk_size` | `2048` | –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–æ–≤ –≤ —Ç–æ–∫–µ–Ω–∞—Ö |
| `--overlap` | `200` | –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏ |
| `--batch_size` | `2` | Batch size (–¥–ª—è 24GB VRAM) |
| `--use_hybrid` | flag | –í–∫–ª—é—á–∞–µ—Ç BM25 + FAISS –≥–∏–±—Ä–∏–¥ |

### Fusion –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ, –≤ –∫–æ–¥–µ)

- `semantic_weight`: 0.7 (BM25=0.3)
- `original_weight`: 1.0
- Fusion method: Convex Combination (CC)

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
# 1. –ù–∞–ª–∏—á–∏–µ submission —Ñ–∞–π–ª–∞
ls -lh outputs/submission_qwen3_rrf_v2_stable.csv

# 2. –§–æ—Ä–º–∞—Ç (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫)
head -5 outputs/submission_qwen3_rrf_v2_stable.csv

# –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
# q_id,web_list
# 0,"[123, 456, 789, ...]"
# 1,"[234, 567, 890, ...]"
# ...

# 3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 6978: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + 6977 –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π)
wc -l outputs/submission_qwen3_rrf_v2_stable.csv
```

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### Pipeline Overview

```
questions_clean.csv (6977 queries)
         ‚Üì
    [Chunker]
         ‚Üì
websites.csv ‚Üí chunks (2048 tokens, overlap 200) ‚Üí ~4,242 chunks
         ‚Üì
[Qwen3-Embedding-8B]
         ‚Üì
   FAISS index ‚Üê embeddings
         ‚Üì
[Hybrid Retrieval: FAISS (70%) + BM25 (30%)]
         ‚Üì
[Convex Combination Fusion]
         ‚Üì
   Top-5 results per query
         ‚Üì
submission_qwen3_rrf_v2_stable.csv
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **SmartChunker** (`src/chunker.py`)
   - –†–∞–∑–±–∏–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ —á–∞–Ω–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
   - chunk_size=2048 —Ç–æ–∫–µ–Ω–æ–≤, overlap=200 —Ç–æ–∫–µ–Ω–æ–≤
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç tiktoken –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤

2. **Qwen3EmbeddingModelStable** (`src/models/qwen3_embedding_stable.py`)
   - Wrapper –¥–ª—è Qwen/Qwen3-Embedding-8B
   - Last token pooling (Context7 –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
   - Instruction formatting –¥–ª—è queries
   - Flash Attention 2 –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

3. **HybridRetriever** (`src/retriever.py`)
   - FAISS (dense retrieval) + BM25 (sparse retrieval)
   - Convex Combination fusion: 70% semantic + 30% BM25
   - Top-k retrieval —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

## üêõ Troubleshooting

### CUDA Out of Memory

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É "CUDA out of memory":

```bash
# –£–º–µ–Ω—å—à–∏—Ç–µ batch_size –≤ run_qwen3_rrf_v2_stable.sh
--batch_size 1  # –≤–º–µ—Å—Ç–æ 2
```

### –ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ HF_HOME –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏
export HF_HOME="$(pwd)/.hf_cache"
export TRANSFORMERS_CACHE="$HF_HOME"
mkdir -p "$HF_HOME"

# –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—É—Å–∫
bash run_qwen3_rrf_v2_stable.sh
```

### –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GPU
python -c "import torch; print(torch.cuda.is_available())"

# –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥: True
```

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–î–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º**: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–≥—É—Ç –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –∏–∑-–∑–∞:
   - –ü–æ—Ä—è–¥–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–∞—Ç—á–µ–π
   - –í–µ—Ä—Å–∏–π –±–∏–±–ª–∏–æ—Ç–µ–∫ (torch, transformers)
   - –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ floating-point –æ–ø–µ—Ä–∞—Ü–∏–π

2. **VRAM**: –ü—Ä–∏ batch_size=2 –æ–∂–∏–¥–∞–µ—Ç—Å—è ~20-22GB VRAM –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

3. **–í—Ä–µ–º—è**: ~15-30 –º–∏–Ω—É—Ç –Ω–∞ RTX 4090:
   - –ß–∞–Ω–∫–æ–≤–∞–Ω–∏–µ: ~1-2 –º–∏–Ω
   - Embedding –≥–µ–Ω–µ—Ä–∞—Ü–∏—è: ~10-20 –º–∏–Ω
   - Retrieval: ~3-5 –º–∏–Ω

---

## üìñ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **–ü–æ–ª–Ω—ã–π –ª–æ–≥ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤**: `PROGRESS_LOG.md`
- **–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**: `experiments/README.md`
- **–ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è**: `REVISED_PLAN.md`
- **–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞**: `CLAUDE.md`

---

## üìß –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã –ø–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–¥–µ–ª **Troubleshooting** –≤—ã—à–µ
2. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤ `PROGRESS_LOG.md`
3. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2025-11-16
